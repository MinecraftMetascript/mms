# Minecraft Metascript (MMS) – Project Guidelines for Junie

This document captures project-specific knowledge needed to build, test, and evolve MMS efficiently. It focuses on non-trivial aspects unique to this repository.

## Tech/Environment
- Language: Go (go 1.23).
- Module path: `github.com/minecraftmetascript/mms`.
- Vendoring: `vendor/` is present; the build typically uses vendored deps. Update vendoring after dependency changes.
- Grammar: ANTLR4 used to generate Go parsers in `lang/grammar` from `grammar/*.g4`.
- CLI: Cobra-based entrypoint (minimal root command for now).
- WASM: Browser-targeted build via `main_wasm.go` and assets in `wasm/`.
- Nix: Optional flake provides devShell and CI-friendly builds with ANTLR generation.

## Repository Layout (selected)
- `lang/`: Core API (Project, File, traversal, constructs, generated grammar package).
  - `lang/Project.go`: Project model, diagnostics aggregation (Project.Diagnostics() returns a slice).
  - `lang/File.go`: File.Parse() populates `File.Diagnostics`.
  - `lang/grammar/`: Generated by ANTLR (do not edit manually).
  - `lang/constructs/…`: Construct registry and implementations (notably worldgen/surface_rules).
  - `lang/traversal/`: Parser traversal, construct registry, scopes.
- `grammar/`: Handwritten ANTLR grammars (`Main_Lexer.g4`, `Main_Parser.g4`, `SurfaceRules_Parser.g4`, etc.).
- `cmd/`: Cobra root command (`mms`).
- `wasm/`: JS glue (`mms.js`), package.json metadata, dist/ artifacts for wasm.
- `examples/`: Example MMS sources (e.g., surface rules). Useful for manual parsing tests.

## Build & Configuration

### Standard build (Nix, recommended)
- Native CLI: `nix build`
  - Produces `./result/bin/mms` (symlink to the Nix store output).
  - Runs `antlr-build` automatically before compiling.
- `main.go` has build tag `!js && !wasm` so it’s selected for native builds.

### WASM build (Nix)
- Build with Nix: `nix build ".#wasm"`
  - Produces `./result/js/` with `dist/main.wasm` and assets (from the Nix derivation in flake.nix).
  - Includes Go’s `wasm_exec.js` at `./result/`.
- `main_wasm.go` has build tag `js && wasm` and exports:
  - `updateFile(filename: string, content: string, cb: (serializedProject: string) => void)`
  - `getFileDiag(filename: string, cb: (json: string) => void)`
- `wasm/package.json` exposes `./mms.js` and `./dist/main.wasm` for NPM packaging.

### Nix (recommended for grammar regeneration)
- Enter dev shell with Go + ANTLR: `nix develop`
  - Provides `antlr-build` helper.
- Build the project with ANTLR generation:
  - `nix build` (runs `antlr-build` before Go build).
- WASM package: `nix build ".#wasm"` (produces `js/` tree with `dist/main.wasm` and assets).
- Note on `vendorHash` in `flake.nix`: currently `null`. If switching to deterministic Nix builds with vendoring:
  1. `go mod vendor`
  2. Compute the vendor hash and set `vendorHash` accordingly (Nix will print the expected value on first build failure).

### Regenerating ANTLR code (non-Nix)
If you prefer without Nix and have ANTLR 4 installed (`antlr4` in PATH):
- Generate lexer: `antlr4 -Dlanguage=Go grammar/Main_Lexer.g4 -o lang -package grammar`
- Generate parser (depends on previously generated package):
  `antlr4 -Dlanguage=Go grammar/Main_Parser.g4 -lib lang/grammar -o lang -package grammar`
- This will update code under `lang/grammar`. Commit generated changes when grammar changes.

## Testing

Important: The legacy tests in `test/` currently don’t compile because `Project.Diagnostics` is now a method, not a field. Example fix pattern:
- Before: `len(p.Diagnostics)` or `for d := range p.Diagnostics { ... }`
- After: `len(p.Diagnostics())` and range over `p.Diagnostics()`.

Until those tests are updated, you can run package-scoped tests to avoid the failing `test/` package.

### How to run tests
- Run all (will currently fail due to `test/`): `go test ./...`
- Run a specific package: `go test ./lang`
- Run a specific test by name with verbose output: `go test ./lang -run TestSmokeParse -v`

### Pattern for adding tests
- Prefer package-local tests near the code under test (e.g., `lang/` for core parsing, constructs under `lang/constructs/...`).
- Create a `Project`, add a `File`, call `Parse()`, then assert on `File.Diagnostics`, `Project.GlobalScope`, or exported `FileTreeLike` via `Project.BuildFsLike()`.
- Diagnostics are accumulated per-file in `File.Diagnostics` and project-wide via `Project.Diagnostics()`.

### Demonstration (validated locally during this update)
A minimal smoke test that asserts the parser reports diagnostics for an intentionally invalid snippet:

```go
package lang

import "testing"

func TestSmokeParse(t *testing.T) {
    p := NewProject()
    file := p.AddFile("smoke.mms", "namespace smoke; blockRule := SurfaceRule.Block minecraft:stone")
    if err := file.Parse(); err != nil {
        t.Fatalf("parse returned error: %v", err)
    }
    if len(file.Diagnostics) == 0 {
        t.Fatalf("expected diagnostics, got none")
    }
}
```

- Command used to run just this test: `go test ./lang -run TestSmokeParse -v` (passed). The file used for the demonstration has been removed from the repository to keep the tree clean.

## Additional Development Notes

- Build tags:
  - `main.go`: `//go:build !js && !wasm`
  - `main_wasm.go`: `//go:build js && wasm`
- Construct registry: New constructs register themselves via `traversal.ConstructRegistry.Register(...)`. See files under `lang/constructs/worldgen/surface_rules/*` for patterns mapping grammar contexts to Go structs and JSON marshaling.
- Export model: `Project.BuildFsLike(root)` walks `GlobalScope` and calls `ExportSymbol` on constructs to emit a directory-like structure (used by WASM packaging, see `main_wasm.go`).
- Code style:
  - Use `gofmt`/`goimports` and `go vet` before committing.
  - Keep generated files in `lang/grammar` untouched; regenerate via ANTLR when grammars change.
- Vendoring:
  - After editing `go.mod`/`go.sum`, run `go mod tidy` and `go mod vendor`.
  - Ensure CI/Nix uses consistent dependency set.
- Examples:
  - `examples/overworld-noise-settings/surface-rules/` contains MMS source examples; useful for manual parse checks with ad-hoc code.

## Quick Commands Reference
- Native build: `nix build`
- WASM build: `nix build ".#wasm"`
- Dev shell (Nix): `nix develop` (includes `antlr-build`)
- Regenerate grammar (Nix): `antlr-build`
- Regenerate grammar (manual):
  - `antlr4 -Dlanguage=Go grammar/Main_Lexer.g4 -o lang -package grammar`
  - `antlr4 -Dlanguage=Go grammar/Main_Parser.g4 -lib lang/grammar -o lang -package grammar`
- Run tests for core package: `go test ./lang -v`
